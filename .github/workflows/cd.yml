name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  lint-backend:
    name: Backend Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync

      - name: Run Black (format check)
        run: uv run black --check .

      - name: Run Ruff (lint)
        run: uv run ruff check .

      - name: Run MyPy (type check)
        run: uv run mypy app/

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync

      - name: Run tests with coverage
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run pytest --ignore=tests/integration -v --cov=app --cov-report=term-missing --cov-fail-under=65

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: .coverage

  lint-frontend:
    name: Frontend Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - name: Run ESLint
        run: npm run lint
        working-directory: frontend

      - name: Run TypeScript type check
        run: npm run type-check
        working-directory: frontend

  build-push-backend:
    name: Build and Push Backend
    runs-on: ubuntu-latest
    needs: [lint-backend, test-backend]
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=raw,value=main-{{sha}}
            type=sha,prefix=sha-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Tag and push to Artifact Registry
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          GHCR_IMAGE="ghcr.io/${{ github.repository }}:main-$SHORT_SHA"
          AR_IMAGE="${{ secrets.GCP_ARTIFACT_REGISTRY }}/technology-risk-register"

          # Pull from GHCR
          docker pull $GHCR_IMAGE

          # Tag for Artifact Registry
          docker tag $GHCR_IMAGE $AR_IMAGE:latest
          docker tag $GHCR_IMAGE $AR_IMAGE:main-$SHORT_SHA
          docker tag $GHCR_IMAGE $AR_IMAGE:sha-$SHORT_SHA

          # Push to Artifact Registry
          docker push $AR_IMAGE:latest
          docker push $AR_IMAGE:main-$SHORT_SHA
          docker push $AR_IMAGE:sha-$SHORT_SHA

          echo "Pushed images to Artifact Registry:"
          echo "  - $AR_IMAGE:latest"
          echo "  - $AR_IMAGE:main-$SHORT_SHA"
          echo "  - $AR_IMAGE:sha-$SHORT_SHA"

      - name: Output image tags
        id: image-tags
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "ghcr_tag=ghcr.io/${{ github.repository }}:main-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "ar_tag=${{ secrets.GCP_ARTIFACT_REGISTRY }}/technology-risk-register:main-$SHORT_SHA" >> $GITHUB_OUTPUT

    outputs:
      image_tag: ${{ steps.image-tags.outputs.ghcr_tag }}
      ar_image_tag: ${{ steps.image-tags.outputs.ar_tag }}
      short_sha: ${{ steps.image-tags.outputs.short_sha }}

  build-upload-frontend:
    name: Build and Upload Frontend
    runs-on: ubuntu-latest
    needs: lint-frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Cloud Run service URL
        id: get-backend-url
        run: |
          SERVICE_URL=$(gcloud run services describe technology-risk-register \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)' || echo "")

          if [ -z "$SERVICE_URL" ]; then
            echo "⚠️  Cloud Run service not found, using placeholder URL"
            SERVICE_URL="https://technology-risk-register-placeholder.a.run.app"
          fi

          echo "backend_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Building frontend with API base URL: $SERVICE_URL"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        env:
          VITE_API_BASE_URL: ${{ steps.get-backend-url.outputs.backend_url }}
        run: npm run build
        working-directory: frontend

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: frontend/dist/
          retention-days: 30

      - name: Get artifact URL
        id: artifact-url
        run: |
          echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT

    outputs:
      artifact_run_id: ${{ steps.artifact-url.outputs.run_id }}
      backend_url: ${{ steps.get-backend-url.outputs.backend_url }}

  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    needs: [build-push-backend, test-backend]
    if: success() && github.ref == 'refs/heads/main'

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy technology-risk-register \
            --image ${{ needs.build-push-backend.outputs.ar_image_tag }} \
            --platform managed \
            --region ${{ secrets.GCP_REGION }} \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --set-env-vars "GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},ENVIRONMENT=production,ALLOWED_ORIGINS=*,DATABASE_URL=sqlite:///./risk_register.db,GCP_BUCKET_NAME=${{ secrets.GCP_PROJECT_ID }}-technology-risk-register-database,AUTH_USERNAME=admin,AUTH_PASSWORD=${{ secrets.AUTH_PASSWORD }},AUTH_SECRET_KEY=${{ secrets.AUTH_SECRET_KEY }},ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}"

          # Get the service URL
          SERVICE_URL=$(gcloud run services describe technology-risk-register \
            --region=${{ secrets.GCP_REGION }} \
            --format='value(status.url)')

          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "✅ Backend deployed successfully to: $SERVICE_URL"

      - name: Health check
        run: |
          SERVICE_URL="${{ steps.deploy.outputs.service_url }}"
          echo "Testing backend health endpoint..."

          # Wait a few seconds for service to be fully ready
          sleep 10

          # Test health endpoint
          if curl -f -s "${SERVICE_URL}/health" > /dev/null; then
            echo "✅ Health check passed!"
            curl -s "${SERVICE_URL}/health" | jq '.'
          else
            echo "⚠️  Health check failed, but deployment may still be successful"
            echo "Check logs: gcloud run services logs tail technology-risk-register --region=${{ secrets.GCP_REGION }}"
          fi

    outputs:
      service_url: ${{ steps.deploy.outputs.service_url }}

  deploy-frontend:
    name: Deploy Frontend to Cloud Storage
    runs-on: ubuntu-latest
    needs: [build-upload-frontend, deploy-backend]
    if: success() && github.ref == 'refs/heads/main'

    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.sha }}
          path: frontend-dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to Cloud Storage
        run: |
          # Upload all files to Cloud Storage bucket
          gsutil -m rsync -r -d frontend-dist gs://${{ secrets.GCP_ASSETS_BUCKET }}

          echo "✅ Files uploaded to Cloud Storage"

      - name: Set cache headers
        run: |
          # CSS files - cache for 1 year
          gsutil -m setmeta -h "Cache-Control:public,max-age=31536000,immutable" \
            "gs://${{ secrets.GCP_ASSETS_BUCKET }}/assets/*.css" || echo "No CSS files to set headers"

          # JS files - cache for 1 year
          gsutil -m setmeta -h "Cache-Control:public,max-age=31536000,immutable" \
            "gs://${{ secrets.GCP_ASSETS_BUCKET }}/assets/*.js" || echo "No JS files to set headers"

          # SVG files - cache for 1 year
          gsutil -m setmeta -h "Cache-Control:public,max-age=31536000,immutable" \
            "gs://${{ secrets.GCP_ASSETS_BUCKET }}/assets/*.svg" || echo "No SVG files to set headers"

          # HTML files - cache for 1 hour
          gsutil -m setmeta -h "Cache-Control:public,max-age=3600,must-revalidate" \
            "gs://${{ secrets.GCP_ASSETS_BUCKET }}/*.html" || echo "No HTML files to set headers"

          echo "✅ Cache headers configured"

      - name: Output deployment info
        run: |
          echo "=========================================="
          echo "  Deployment Complete! ✓"
          echo "=========================================="
          echo ""
          echo "Backend:"
          echo "  Service URL: ${{ needs.deploy-backend.outputs.service_url }}"
          echo "  API Docs: ${{ needs.deploy-backend.outputs.service_url }}/docs"
          echo "  Health: ${{ needs.deploy-backend.outputs.service_url }}/health"
          echo ""
          echo "Frontend:"
          echo "  Storage Bucket: gs://${{ secrets.GCP_ASSETS_BUCKET }}"
          echo "  Access via Load Balancer or configured domain"
          echo ""
          echo "Deployment Info:"
          echo "  Commit: ${{ github.sha }}"
          echo "  Triggered by: ${{ github.actor }}"
          echo "  Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
